{"name":"AcePHProxy","tagline":"PHP-прокси демон для Ace Stream. Позволяет смотреть торрент-ТВ на любом устройстве","body":"# О проекте\r\nПопробовав однажды [AceProxy](https://github.com/ValdikSS/aceproxy) от автора @ValdikSS, я решил написать \"такой же, но без крыльев\". Плеер использовал XBMC, и было с ним ряд неудобств. А именно: \r\n\r\n1. долгое время старта трансляции\r\n2. долгое открытие m3u листа с каналами (чем их больше, тем дольше ждать)\r\n3. очень долго ждать реакции при зависании/обрыве потока\r\n\r\nи немного по самому софту\r\n\r\n4. требует VLC для просмотра одного канала на нескольких устройствах одновременно\r\n5. работал очень нестабильно, особенно в режиме с VLC. Это по сути и стало толчком\r\n\r\nДолгое время старта (при открытии трансляции затык на 4 сек), а также крайне долгое открытие плейлиста всего из 10 ссылок, оказалось следствием двух дополнительных запросов от XBMC: один HEAD-запрос ссылки, другой с заголовком Range: 0-0.\r\nИ так на каждую ссылку, с ожиданием ответа по 2 сек. Доставало неимоверно.\r\nА поскольку тормозящий софт я страсть как не люблю, то решил..\r\n\r\n# Напишу свой Ace Proxy, с UI и плюшками\r\nСказано - сделано.\r\nНа PHP (о ужас!) был написан демон, при старте он открывает порт для клиентов и коннект до AceStream.\r\n### Многопользовательский режим\r\nКлиенты обращаются к демону по ссылке вида http://10.0.0.1:8000/pid/09fdc09e780fe62fb8187bf74ae2c05c3ebcc90e/2x2\r\nДемон обращается к AceStream, запускает полученный PID, дожидается ссылки на поток от Ace и открывает ее, ассоциирует клиента с потоком и начинает перекачивать данные из потока на клиент. Если подключится еще один клиент с таким же PID, то поток будет копироваться уже на 2 клиента, или на 3, 4, 10..\r\n### Адаптивная подстройка буфера\r\nРазмер куска (буфера), читаемого из Ace, определяется для каждого потока, корректируется непрерывно и хранится в настройках. Это позволило быстро стартовать трансляцию, быстро запускать ее на каждом новом клиенте, устранить начальную буферизацию. Но нужно не забыть запустить acestreamengine с правильными параметрами\r\n### Ncurses-UI\r\nТут особенно рассказывать нечего, демоны обычно запускаются в консоли и либо молчат, либо \"срут в логи\". Мне же хотелось наблюдать картину со списком клиентов, трансляций, отдельным окном логов, какими-нибудь строками состояния, да еще и в цвете, мало того - обновляющееся realtime. Реализовал все это на ncurses.\r\n### XBMC-уведомления\r\nИногда трансляция не открывается по какой-то причине, иногда она ломается и не запускается больше, иногда пропадает интернет, и во всех этих случаях мне приходилось лезть в консоль и смотреть что случилось.\r\nЯ решил реализовать всплывающие уведомления на XBMC узлы (требуется включить в настройках XBMC управление извне), теперь если падает интернет, или демон делает попытку перезапустить трансляцию, потому что Ace рухнул, я получаю всплывающее уведомление об этом на экране.\r\n\r\n# Что получилось\r\nНемного картинок\r\n\r\nУведомление об ошибке запуска Travel HD. Ace не предоставил ссылку на поток\r\n![Stream start error notification](https://lh5.googleusercontent.com/GmVQStyShCjEOxSU-GKgZCa5O3YiHhnGOAwwS9xwoXK0ReDg-SkmBcKj_wHNOBZeDyUUhrGPdPMO1Wg=w1444-h670-rw)\r\n\r\nДемонстрация ncurses-ui. 3 клиента на поток 2х2, ошибка запуска другой трансляции\r\n![UI](https://lh3.googleusercontent.com/POujMufcmuFgnnGAT_bCYRDD9SKPbYbFoqZDeBGogXosSje5vpVb7Gkc-rRTo8qvDtmvz3ddLnSgYhc=w1444-h670-rw)\r\n\r\nПерезапуск потока, я убил Ace Server (тот поднимается через 3 сек сам)\r\n![Stream restart](https://lh4.googleusercontent.com/UQqNXQGFPMC-B_q_fmbvwuWM1E2o1alvCylTfQM895vTHRXsRd13QLFfmaTR8lBAtYT0MNlzcuE5B8E=w1444-h670-rw)\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}